// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Privacy policy acceptance
  privacyAccepted   Boolean   @default(false) @map("privacy_accepted")
  privacyAcceptedAt DateTime? @map("privacy_accepted_at")

  // Terms of service acceptance
  termsAccepted   Boolean   @default(false) @map("terms_accepted")
  termsAcceptedAt DateTime? @map("terms_accepted_at")

  // Progress photo encryption key (server-wrapped)
  progressPhotoKeyEnc String? @map("progress_photo_key_enc")
  progressPhotoKeyIv  String? @map("progress_photo_key_iv")
  progressPhotoKeyVersion Int? @default(1) @map("progress_photo_key_version")

  // Two-factor authentication
  twoFactorEnabled     Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?  @map("two_factor_secret")
  twoFactorBackupCodes String[] @default([]) @map("two_factor_backup_codes")

  // Fitness-related fields
  height          Float?
  weight          Float? // Monthly average weight used for meal tracking and calculations
  birthdate       DateTime? // User's date of birth for age calculation
  gender          String? // "male" or "female"
  fitnessGoals    String?
  activityLevel   String?
  experienceLevel String?   @default("beginner") // "beginner", "intermediate", "advanced"

  accounts                Account[]
  sessions                Session[]
  workouts                Workout[]
  workoutTemplates        WorkoutTemplate[]
  workoutSessions         WorkoutSession[]
  exercises               Exercise[]
  nutritionLogs           NutritionLog[]
  preferences             UserPreference?
  foods                   Food[]
  meals                   Meal[]
  savedWorkoutStates      SavedWorkoutState[]
  weightEntries           WeightEntry[]
  schedules               Schedule[]
  scheduleTemplates       ScheduleTemplate[]
  pushSubscriptions       PushSubscription[]
  completedDays           CompletedDay[]
  recoveryFeedbacks       RecoveryFeedback[]
  dailyCheckIns           DailyCheckIn[]
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  progressionNodes        ProgressionNodeProgress[]
  progressionProfile      ProgressionProfile?
  progressPhotos          ProgressPhoto[]
  // New schedule system relations
  dailyTemplates          DailyTemplate[]
  weeklyTemplates         WeeklyTemplate[]
  activeSchedules         ActiveSchedule[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  email      String // Email to verify
  token      String    @unique // URL token
  code       String // 6-digit verification code
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  verifiedAt DateTime? @map("verified_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([code])
  @@map("email_verification_tokens")
}

enum ProgressionNodeStatus {
  LOCKED
  AVAILABLE
  COMPLETED
}

model ProgressionNodeProgress {
  id              String                @id @default(cuid())
  userId          String                @map("user_id")
  nodeId          String                @map("node_id")
  status          ProgressionNodeStatus @default(AVAILABLE)
  completionCount Int                   @default(0) @map("completion_count")
  xpEarned        Int                   @default(0) @map("xp_earned")
  lastCompletedAt DateTime?             @map("last_completed_at")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, nodeId])
  @@index([nodeId])
  @@map("progression_node_progress")
}

model ProgressionProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  alias     String   @unique
  crowns    Int      @default(0)
  totalXp   Int      @default(0) @map("total_xp")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("progression_profiles")
}

// Fitness-related models
model WorkoutTemplate {
  id                String   @id @default(cuid())
  userId            String?  @map("user_id") // null for predefined templates
  name              String
  description       String?
  estimatedDuration Int      @default(30) // minutes
  category          String? // e.g., "upper-body", "lower-body", "full-body"
  difficulty        String? // "beginner", "intermediate", "advanced"
  isPublic          Boolean  @default(false)
  isPredefined      Boolean  @default(false)
  isAiGenerated     Boolean  @default(false) // flag to track AI-generated templates
  usageCount        Int      @default(0)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user            User?                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises       WorkoutTemplateExercise[]
  workoutSessions WorkoutSession[]
  dailyTemplates  DailyTemplate[]

  @@map("workout_templates")
}

model Exercise {
  id           String   @id @default(cuid())
  name         String
  description  String?
  instructions String?
  gifUrl       String?
  isPublic     Boolean  @default(false)
  isPredefined Boolean  @default(false)
  userId       String?  @map("user_id") // null for predefined exercises
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user              User?                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  templateExercises WorkoutTemplateExercise[]
  sessionExercises  WorkoutSessionExercise[]

  // Relations to global entities
  bodyParts  ExerciseBodyPart[]
  equipments ExerciseEquipment[]
  muscles    ExerciseMuscle[]

  @@map("exercises")
}

model BodyPart {
  id        String             @id @default(cuid())
  name      String             @unique
  exercises ExerciseBodyPart[]

  @@map("body_parts")
}

model Equipment {
  id        String              @id @default(cuid())
  name      String              @unique
  exercises ExerciseEquipment[]

  @@map("equipments")
}

model Muscle {
  id        String           @id @default(cuid())
  name      String           @unique
  exercises ExerciseMuscle[]

  @@map("muscles")
}

// Join tables for many-to-many
model ExerciseBodyPart {
  id         String   @id @default(cuid())
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId String   @map("exercise_id")
  bodyPart   BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Cascade)
  bodyPartId String   @map("body_part_id")

  @@unique([exerciseId, bodyPartId])
  @@map("exercise_body_parts")
}

model ExerciseEquipment {
  id          String    @id @default(cuid())
  exercise    Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId  String    @map("exercise_id")
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  equipmentId String    @map("equipment_id")

  @@unique([exerciseId, equipmentId])
  @@map("exercise_equipments")
}

model ExerciseMuscle {
  id         String   @id @default(cuid())
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId String   @map("exercise_id")
  muscle     Muscle   @relation(fields: [muscleId], references: [id], onDelete: Cascade)
  muscleId   String   @map("muscle_id")
  isPrimary  Boolean  @default(false)

  @@unique([exerciseId, muscleId])
  @@map("exercise_muscles")
}

model WorkoutTemplateExercise {
  id                String  @id @default(cuid())
  workoutTemplateId String  @map("workout_template_id")
  exerciseId        String  @map("exercise_id")
  order             Int     @default(0)
  targetSets        Int     @default(3)
  targetReps        String  @default("8-12") // can be "8-12" or "30 seconds"
  targetType        String  @default("reps") // "reps" or "time"
  targetWeight      Float? // optional target weight
  restTime          Int     @default(90) // seconds
  notes             String?

  workoutTemplate WorkoutTemplate @relation(fields: [workoutTemplateId], references: [id], onDelete: Cascade)
  exercise        Exercise        @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([workoutTemplateId, exerciseId])
  @@map("workout_template_exercises")
}

model WorkoutSession {
  id                String    @id @default(cuid())
  userId            String    @map("user_id")
  workoutTemplateId String?   @map("workout_template_id") // null for custom sessions
  name              String
  description       String?
  startTime         DateTime  @default(now())
  endTime           DateTime?
  duration          Int? // actual duration in seconds
  status            String    @default("active") // "active", "completed", "paused"
  performanceStatus String? // "completed", "perfect"
  completionRate    Float? // percentage of workout completed (0-100)
  perfectionScore   Float? // score for how well user performed (0-100)
  notes             String?
  isArchived        Boolean   @default(false) @map("is_archived")
  archivedAt        DateTime? @map("archived_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user            User?                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutTemplate WorkoutTemplate?         @relation(fields: [workoutTemplateId], references: [id])
  exercises       WorkoutSessionExercise[]
  savedState      SavedWorkoutState?

  @@map("workout_sessions")
}

model WorkoutSessionExercise {
  id               String   @id @default(cuid())
  workoutSessionId String   @map("workout_session_id")
  exerciseId       String   @map("exercise_id")
  order            Int      @default(0)
  targetSets       Int      @default(3)
  targetReps       String   @default("8-12")
  targetType       String   @default("reps") // "reps" or "time"
  notes            String?
  completed        Boolean  @default(false)
  completedSets    Int      @default(0) // track how many sets were actually completed
  perfectionScore  Float? // individual exercise performance score (0-100)
  createdAt        DateTime @default(now()) @map("created_at")

  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exercise       Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  sets           ExerciseSet[]

  @@map("workout_session_exercises")
}

model ExerciseSet {
  id                       String   @id @default(cuid())
  workoutSessionExerciseId String   @map("workout_session_exercise_id")
  setNumber                Int
  reps                     Int?
  weight                   Float?
  duration                 Int? // for time-based exercises (seconds)
  completed                Boolean  @default(false)
  restTime                 Int? // actual rest time taken
  notes                    String?
  createdAt                DateTime @default(now()) @map("created_at")

  workoutSessionExercise WorkoutSessionExercise @relation(fields: [workoutSessionExerciseId], references: [id], onDelete: Cascade)

  @@unique([workoutSessionExerciseId, setNumber])
  @@map("exercise_sets")
}

enum RecoveryFeeling {
  GOOD
  TIGHT
  SORE
  INJURED
}

model RecoveryFeedback {
  id        String          @id @default(cuid())
  userId    String          @map("user_id")
  bodyPart  String          @map("body_part")
  feeling   RecoveryFeeling @default(GOOD)
  intensity Int?
  note      String?
  createdAt DateTime        @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bodyPart])
  @@map("recovery_feedback")
}

model DailyCheckIn {
  id          String              @id @default(cuid())
  userId      String              @map("user_id")
  date        DateTime
  energyLevel Int                 @map("energy_level")
  notes       String?
  createdAt   DateTime            @default(now()) @map("created_at")
  bodyPartChecks BodyPartCheck[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("daily_check_in")
}

model BodyPartCheck {
  id            String   @id @default(cuid())
  checkInId     String   @map("check_in_id")
  bodyPart      String   @map("body_part")
  sorenessLevel Int      @map("soreness_level")
  createdAt     DateTime @default(now()) @map("created_at")

  checkIn DailyCheckIn @relation(fields: [checkInId], references: [id], onDelete: Cascade)

  @@index([checkInId])
  @@index([bodyPart])
  @@map("body_part_check")
}

// Model to save workout progress when user exits mid-workout
model SavedWorkoutState {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")
  workoutSessionId     String   @unique @map("workout_session_id")
  currentExerciseIndex Int      @default(0)
  timer                Int      @default(0) // seconds
  exerciseTimer        Int      @default(0) // seconds for current exercise
  isTimerRunning       Boolean  @default(false)
  isResting            Boolean  @default(false)
  restTimer            Int      @default(0)
  lastSetData          Json? // Store last set data (reps, weight) for quick access
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)

  @@map("saved_workout_states")
}

model Workout {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  description String?
  duration    Int // minutes
  exercises   Json // Store exercises as JSON - keeping for backward compatibility
  date        DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("workouts")
}

model NutritionLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime @default(now())
  meals     Json // Store meals as JSON
  calories  Int
  protein   Float
  carbs     Float
  fat       Float
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("nutrition_logs")
}

// User preferences stored as JSON for flexibility
model UserPreference {
  userId    String   @id @map("user_id")
  workout   Json
  nutrition Json
  app       Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

/**
 * model UserPreference {
 * userId     String   @id @map("user_id")
 * // Workout preferences
 * defaultDuration String @default("45")
 * difficultyLevel String @default("intermediate")
 * preferredTime   String @default("morning")
 * availableEquipment Json // Array of equipment strings
 * restDayReminders Boolean @default(true)
 * // Nutrition preferences
 * dailyCalories String @default("2200")
 * proteinTarget String @default("150")
 * carbTarget    String @default("250")
 * fatTarget     String @default("80")
 * dietaryRestrictions Json // Array of restriction strings
 * trackWater    Boolean @default(true)
 * waterTarget   String @default("2500")
 * useSmartCalculations Boolean @default(true)
 * // App preferences
 * theme         String @default("system")
 * units         String @default("imperial")
 * notifications Boolean @default(true)
 * weeklyReports Boolean @default(true)
 * dataSharing   Boolean @default(false)
 * // Email notification preferences
 * emailNotifications   Boolean @default(true)
 * pushNotifications    Boolean @default(true)
 * weighInNotifications Boolean @default(true)
 * weighInFrequency     Int @default(1) // 1, 2, or 3
 * mealNotifications    Boolean @default(true)
 * mealFrequency        Int @default(3) // 1 or 3
 * sleepNotifications   Boolean @default(true)
 * exerciseNotifications Boolean @default(true)
 * workoutReminders     Boolean @default(true)
 * weightReminders      Boolean @default(true)
 * nutritionReminders   Boolean @default(true)
 * streakReminders      Boolean @default(true)
 * reminderTime         String @default("09:00")
 * // Admin notification settings
 * adminNotifications Json // { enabled: boolean, methods: string[], errorAlerts: boolean, startupAlerts: boolean }
 * createdAt  DateTime @default(now()) @map("created_at")
 * updatedAt  DateTime @updatedAt @map("updated_at")
 * user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 * @@map("user_preferences")
 * }
 */

model Food {
  id          String   @id @default(cuid())
  name        String
  brand       String?
  calories    Float
  protein     Float
  carbs       Float
  fat         Float
  fiber       Float?
  sugar       Float?
  sodium      Float?
  servingSize Float // in grams
  servingUnit String   @default("g")
  category    String? // e.g., "protein", "vegetable", "fruit", etc.
  verified    Boolean  @default(false) // for user-added vs verified foods
  isPublic    Boolean  @default(false) // allow users to share their custom foods
  userId      String?  @map("user_id") // null for global foods, userId for custom foods
  usageCount  Int      @default(0) // track how many times this food is used
  createdAt   DateTime @default(now()) @map("created_at")

  user            User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealIngredients MealIngredient[]

  @@map("foods")
}

model Meal {
  id            String   @id @default(cuid())
  name          String
  description   String?
  totalCalories Float
  totalProtein  Float
  totalCarbs    Float
  totalFat      Float
  totalFiber    Float?
  totalSugar    Float?
  totalSodium   Float?
  isPublic      Boolean  @default(false)
  userId        String   @map("user_id")
  createdAt     DateTime @default(now()) @map("created_at")

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients MealIngredient[]

  @@map("meals")
}

model MealIngredient {
  id        String   @id @default(cuid())
  mealId    String   @map("meal_id")
  foodId    String   @map("food_id")
  quantity  Float // how many servings/units
  createdAt DateTime @default(now()) @map("created_at")

  meal Meal @relation(fields: [mealId], references: [id], onDelete: Cascade)
  food Food @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@map("meal_ingredients")
}

model WeightEntry {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  weight    Float // weight in pounds or kg depending on user preference
  date      DateTime @default(now()) // when the weight was recorded
  notes     String? // optional notes about the weigh-in
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("weight_entries")
}

// ============================================
// NEW SCHEDULE SYSTEM - Simplified & Intuitive
// ============================================

// Daily Template: A single workout for one day (e.g., "Upper Body", "Leg Day", "Cardio")
// Links to an existing WorkoutTemplate
model DailyTemplate {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  name              String // e.g., "Upper Body Day", "Leg Day", "Rest Day"
  workoutTemplateId String?  @map("workout_template_id") // null for rest days
  cardioType        String?  @map("cardio_type") // "bike", "walk", "run", "jump_rope"
  startTime         String   @default("09:00") // Preferred time HH:MM
  duration          Int      @default(60) // Duration in minutes
  color             String?  @default("#3b82f6") // Color for calendar display
  isRestDay         Boolean  @default(false) @map("is_rest_day")
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutTemplate WorkoutTemplate?        @relation(fields: [workoutTemplateId], references: [id], onDelete: SetNull)
  weeklyDays      WeeklyTemplateDay[]

  @@index([userId])
  @@map("daily_templates")
}

// Weekly Template: 7 days made up of daily templates
// e.g., "Push Pull Legs" = Mon: Push, Tue: Pull, Wed: Legs, Thu: Push, Fri: Pull, Sat: Legs, Sun: Rest
model WeeklyTemplate {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String // e.g., "Push Pull Legs", "Upper Lower Split"
  description String?
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  days            WeeklyTemplateDay[]
  activeSchedules ActiveSchedule[]

  @@index([userId])
  @@map("weekly_templates")
}

// Junction table: Which daily template is assigned to which day of the week
model WeeklyTemplateDay {
  id               String   @id @default(cuid())
  weeklyTemplateId String   @map("weekly_template_id")
  dailyTemplateId  String?  @map("daily_template_id") // null for unassigned/rest
  dayOfWeek        Int // 0 = Sunday, 1 = Monday, ... 6 = Saturday
  overrideTime     String? // Override the daily template's start time for this specific day
  createdAt        DateTime @default(now()) @map("created_at")

  weeklyTemplate WeeklyTemplate @relation(fields: [weeklyTemplateId], references: [id], onDelete: Cascade)
  dailyTemplate  DailyTemplate? @relation(fields: [dailyTemplateId], references: [id], onDelete: SetNull)

  @@unique([weeklyTemplateId, dayOfWeek])
  @@map("weekly_template_days")
}

// Active Schedule: A weekly template applied with start/end dates
// This is what actually schedules workouts on the calendar
model ActiveSchedule {
  id               String    @id @default(cuid())
  userId           String    @map("user_id")
  weeklyTemplateId String    @map("weekly_template_id")
  name             String? // Optional name override
  startDate        DateTime // When this schedule starts
  endDate          DateTime? // null = repeats forever until manually stopped
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  weeklyTemplate WeeklyTemplate @relation(fields: [weeklyTemplateId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("active_schedules")
}

// ============================================
// LEGACY SCHEDULE MODELS (kept for migration)
// ============================================

model Schedule {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  weekStart DateTime // Start of the week (Sunday)
  name      String? // Optional name for the schedule
  timezone  String?  @default("UTC")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items ScheduleItem[]

  @@unique([userId, weekStart])
  @@index([userId, weekStart])
  @@map("schedules")
}

model ScheduleItem {
  id               String    @id @default(cuid())
  scheduleId       String    @map("schedule_id")
  type             String // "workout" | "meal"
  title            String
  description      String?
  startTime        String // HH:MM format
  endTime          String // HH:MM format
  day              Int // 0 = Sunday, 1 = Monday, etc.
  category         String?
  calories         Int?
  difficulty       String?
  duration         Int? // in minutes
  isRecurring      Boolean   @default(false) @map("is_recurring")
  repeatPattern    String?   @map("repeat_pattern") // "daily" | "weekly" | "yearly"
  repeatInterval   Int?      @map("repeat_interval")
  repeatEndsOn     DateTime? @map("repeat_ends_on")
  recurrenceRule   Json?     @map("recurrence_rule")
  repeatDaysOfWeek Int[]     @map("repeat_days_of_week")
  isFromGenerator  Boolean   @default(false)
  generatorData    Json? // Original data from AI generator
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId, day])
  @@map("schedule_items")
}

model ScheduleTemplate {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id") // null for default templates
  name        String
  description String?
  isDefault   Boolean  @default(false)
  isPublic    Boolean  @default(false)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user  User?                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  items ScheduleTemplateItem[]

  @@map("schedule_templates")
}

model ScheduleTemplateItem {
  id          String   @id @default(cuid())
  templateId  String   @map("template_id")
  type        String // "workout" | "meal"
  title       String
  description String?
  startTime   String // HH:MM format
  endTime     String // HH:MM format
  day         Int // 0 = Sunday, 1 = Monday, etc.
  category    String?
  calories    Int?
  difficulty  String?
  duration    Int? // in minutes
  createdAt   DateTime @default(now()) @map("created_at")

  template ScheduleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, day])
  @@map("schedule_template_items")
}

// Push notification subscription model
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  keys      Json // Store p256dh and auth keys
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

// Track completed workout days
model CompletedDay {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime // The date that was completed (date only, time set to 00:00:00)
  status    String   @default("completed") // "completed", "in_progress"
  notes     String? // Optional notes about the completion
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("completed_days")
}

// Progress photos for tracking visual transformation
model ProgressPhoto {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  imageUrl   String   @map("image_url") // URL to the stored image (S3 or local storage)
  storageProvider String @default("local") @map("storage_provider") // "local" | "appwrite"
  storageFileId String? @map("storage_file_id")
  notes      String? // User's notes about this photo
  bodyParts  String[] @default([]) @map("body_parts")
  fileIv     String?  @map("file_iv")
  fileMimeType String? @map("file_mime_type")
  encryptionVersion Int? @default(1) @map("encryption_version")
  uploadDate DateTime @map("upload_date") // When the photo was taken/marked
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, uploadDate(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("progress_photos")
}
